{"version":3,"sources":["dist/app.es6.js"],"names":[],"mappings":"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","file":"dist/app.es6.js","sourcesContent":["'use strict';\r\n// (4.22208334636).fixed(n) will return fixed point value to n places, default n = 3\r\nNumber.prototype.fixed = function(n_) { n_ = n_ || 3; return parseFloat(this.toFixed(n_)); };\r\n\r\nclass Common\r\n{\r\n    constructor()\r\n    {\r\n        //The speed at which the clients move.\r\n        this.avatarspeed = 120;\r\n        this.owntime_ = 0.016;\r\n        this.world = { width: 720, height: 480 };\r\n    }\r\n\r\n    /*\r\n     Shared between server and client.\r\n     In this example, `item` is always of type avatar.\r\n     */\r\n    check_collision(item_)\r\n    {\r\n        if (item_.pos.x < item_.pos_limits.x_min || item_.pos.x > item_.pos_limits.x_max)\r\n        {\r\n            item_.pos.x = Math.min(Math.max(item_.pos.x, item_.pos_limits.x_min),\r\n                                   item_.pos_limits.x_max);\r\n        }\r\n        if (item_.pos.y < item_.pos_limits.y_min || item_.pos.y > item_.pos_limits.y_max)\r\n        {\r\n            item_.pos.y = Math.min(Math.max(item_.pos.y, item_.pos_limits.y_min),\r\n                                   item_.pos_limits.y_max);\r\n        }\r\n        //Fixed point helps be more deterministic\r\n        item_.pos.x = item_.pos.x.fixed(4);\r\n        item_.pos.y = item_.pos.y.fixed(4);\r\n    }\r\n\r\n    process_input(avatar_)\r\n    {\r\n        //It's possible to have recieved multiple inputs by now,\r\n        //so we process each one\r\n        let x_dir = 0;\r\n        let y_dir = 0;\r\n        let ic = avatar_.inputs.length;\r\n        if (ic) //if we have inputs\r\n        {\r\n            for (let j = 0; j < ic; ++j) //for each input command\r\n            {\r\n                //don't process ones we already have simulated locally\r\n                if (avatar_.inputs[j].seq <= avatar_.last_input_seq) { continue; }\r\n\r\n                let input = avatar_.inputs[j].inputs;\r\n                let c = input.length;\r\n                for (let i = 0; i < c; ++i) //for all input values\r\n                {\r\n                    let key = input[i];\r\n                    if (key == 'l') { x_dir -= 1; }\r\n                    if (key == 'r') { x_dir += 1; }\r\n                    if (key == 'd') { y_dir += 1; }\r\n                    if (key == 'u') { y_dir -= 1; }\r\n                }\r\n            }\r\n        }\r\n\r\n        //we have a direction vector now, so apply the same physics as the client\r\n        let resulting_vector = this.physics_movement_vector_from_direction(x_dir, y_dir);\r\n        if (avatar_.inputs.length)\r\n        {\r\n            //we can now clear the array since these have been processed\r\n            avatar_.last_input_time = avatar_.inputs[ic - 1].time;\r\n            avatar_.last_input_seq = avatar_.inputs[ic - 1].seq;\r\n        }\r\n\r\n        //give it back\r\n        return resulting_vector;\r\n    }\r\n\r\n    physics_movement_vector_from_direction(x_, y_)\r\n    {\r\n        //Must be fixed step, at physics sync speed.\r\n        return { x: (x_ * (this.avatarspeed * 0.015)).fixed(3),\r\n                 y: (y_ * (this.avatarspeed * 0.015)).fixed(3) };\r\n    }\r\n\r\n    start_physics_loop(component_)\r\n    {\r\n        //Set up some physics integration values\r\n        this._pdt = 0.0001; //The physics update delta time\r\n        this._pdte = new Date().getTime(); //The physics update last delta time\r\n        //A local timer for precision on server and client\r\n        this.owntime_ = 0.016; //The local timer\r\n        this._dt = new Date().getTime(); //The local timer delta\r\n        this._dte = new Date().getTime(); //The local timer last frame time\r\n\r\n        //Start a physics loop, this is separate to the rendering\r\n        //as this happens at a fixed frequency\r\n        setInterval(() => { this._pdt = (new Date().getTime() - this._pdte) / 1000.0;\r\n                            this._pdte = new Date().getTime();\r\n                            component_.update_physics(this._pdt); },\r\n                    15);\r\n\r\n        //Start a fast paced timer for measuring time easier\r\n        setInterval(() => { this._dt = new Date().getTime() - this._dte;\r\n                            this._dte = new Date().getTime();\r\n                            this.set_owntime(this.owntime_ + this._dt / 1000.0); },\r\n                    4);\r\n    }\r\n\r\n    set_owntime(v_) { if (v_) { this.owntime_ = v_;} }\r\n    get_owntime() { return this.owntime_; }\r\n\r\n    /*\r\n     Helper functions for the session code\r\n\r\n     Here we have some common maths and session related code to make working with 2d vectors easy,\r\n     as well as some helpers for rounding numbers to fixed point.\r\n     */\r\n    //copies a 2d vector like object from one to another\r\n    new_pos(a_) { return { x: a_.x, y: a_.y }; }\r\n    //Add a 2d vector with another one and return the resulting vector\r\n    v_add(a_, b_) { return { x: (a_.x + b_.x).fixed(), y: (a_.y + b_.y).fixed() }; }\r\n    //Subtract a 2d vector with another one and return the resulting vector\r\n    v_sub(a_, b_) { return { x: (a_.x - b_.x).fixed(), y: (a_.y - b_.y).fixed() }; }\r\n    //Multiply a 2d vector with a scalar value and return the resulting vector\r\n    v_mul_scalar(a_, b_) { return { x: (a_.x * b_).fixed(), y: (a_.y * b_).fixed() }; }\r\n    //Simple linear interpolation\r\n    lerp(p_, n_, t_) { let t = Number(t_); t = Math.max(0, Math.min(1, t)).fixed(); return (p_ + t * (n_ - p_)).fixed(); }\r\n    //Simple linear interpolation between 2 vectors\r\n    v_lerp(v_, tv_, t_) { return { x: this.lerp(v_.x, tv_.x, t_), y: this.lerp(v_.y, tv_.y, t_) }; }\r\n};\r\n\r\nlet cm = new Common();\r\n\r\n// http://stackoverflow.com/questions/30339675/how-to-map-json-data-to-a-class\r\n\r\n/*\r\n The avatar class\r\n A simple class to maintain state of a avatar on screen.\r\n*/\r\nclass Avatar\r\n{\r\n    constructor(socket_)\r\n    {\r\n        //Store the instance, if any\r\n        this.socket = socket_;\r\n        // this.userid = socket_.userid;\r\n\r\n        //Set up initial values for our state information\r\n        this.pos = { x: 0, y: 0 };\r\n        this.size = { x: 16, y: 16, hx: 8, hy: 8 };\r\n        this.state = 'not-connected';\r\n        this.color = 'rgba(255,255,255,0.1)';\r\n        this.info_color = 'rgba(255,255,255,0.1)';\r\n        this.id = '';\r\n        //These are used in moving us around later\r\n        this.old_state = { pos: { x: 0, y: 0 } };\r\n        this.cur_state = { pos: { x: 0, y: 0 } };\r\n        this.state_time = new Date().getTime();\r\n        //Our local history of inputs\r\n        this.inputs = [];\r\n        //The world bounds we are confined to\r\n        this.pos_limits = { x_min: this.size.hx,\r\n                            x_max: cm.world.width - this.size.hx,\r\n                            y_min: this.size.hy,\r\n                            y_max: cm.world.height - this.size.hy };\r\n        //The 'host' of a session gets created with a avatar instance since\r\n        //the server already knows who they are. If the server starts a session\r\n        //with only a host, the other avatar is set up in the 'else' below\r\n        if (this.socket) { this.pos = { x: 20, y: 20 }; }\r\n        else { this.pos = { x: 500, y: 200 }; }\r\n    }\r\n};\r\n\r\nclass SvModel\r\n{\r\n    constructor()\r\n    {\r\n    }\r\n\r\n    get_avatar_json()\r\n    {\r\n        let avatar = new Avatar();\r\n        avatar.state_time = 0;\r\n\r\n        return JSON.stringify(avatar);\r\n    }\r\n};\r\n\r\nclass SvSession\n{\n    constructor(socket_, cl_id_)\n    {\n        let UUID = require('node-uuid');\n        this.id = UUID(); // generate a new id for the session\n\n        this.socket_host =  socket_; // so we know who initiated the session\n        this.socket_client =  null; // nobody else joined yet, since its new\n        this.avatar_count =  1;\n\n        this.frame_time_ = 45; //on server we run at 45ms, 22hz\n        this.sv_time = 0;\n        this.last_time = 0;\n        this.laststate = {};\n\n        // Model distribution\n        let sv_mdl = new SvModel();\n        sv_mdl.get_avatar_json();\n\n        //We create a avatar set, passing them\n        //the session that is running them, as well\n        this.avatars = [new Avatar(this.socket_host), new Avatar(this.socket_client)];\n\n        this.avatars[0].pos = { x: 20, y: 20 };\n        cm.start_physics_loop(this);\n\n        // initialize host\n        //tell the avatar that they are now the host\n        //s=server message, h=you are hosting\n        this.socket_host.send('s.h.' + String(cm.get_owntime()).replace('.', '-'));\n    }\n\n    //Main update loop\n    update(t_)\n    {\n        //Update the session specifics\n        //Update the state of our local clock to match the timer\n        this.sv_time = cm.get_owntime();\n\n        this.laststate = { pos: this.avatars.map((a_) => { return a_.pos; }),\n                           inp_seq: this.avatars.map((a_) => { return a_.last_input_seq; }),\n                           t: this.sv_time }; // our current local time on the server\n\n        for (let avatar of this.avatars)\n        { if (avatar.socket) { avatar.socket.emit('onserverupdate', this.laststate); } }\n\n        let currTime = Date.now(),\n            timeToCall = Math.max(0, this.frame_time_ - (currTime - this.last_time));\n\n        //schedule the next update\n        this.updateid = setTimeout(() => { this.update(currTime + timeToCall); }, timeToCall);\n        this.last_time = currTime + timeToCall;\n    }\n\n    stop(user_id_)\n    {\n        clearTimeout(this.updateid);\n\n        //if the session has two avatars, the one is leaving\n        if (this.avatar_count > 1)\n        {\n            //send the avatars the message the session is ending\n            if (user_id_ == this.socket_host.userid)\n            {\n                //the host left, oh snap. Lets try join another session\n                if (this.socket_client)\n                {\n                    //tell them the session is over\n                    this.socket_client.send('s.e');\n                    //now look for/create a new session.\n                    return this.socket_client;\n                }\n            }\n            else\n            {\n                //the other avatar left, we were hosting\n                if (this.socket_host)\n                {\n                    //tell the client the session is ended\n                    this.socket_host.send('s.e');\n                    //i am no longer hosting, this session is going down\n                    //now look for/create a new session.\n                    return this.socket_host;\n                }\n            }\n        }\n        return null;\n    }\n\n    try_to_start(cl_socket_, cl_id_)\n    {\n        //If the session is a avatar short\n        if (this.avatar_count >= 2) { return false; } //if more than 2 avatars\n\n        //increase the avatar count and store\n        //the avatar as the client of this session\n        this.socket_client = cl_socket_;\n        this.avatars[1].socket = cl_socket_;\n        this.avatar_count++;\n\n        //start running the session on the server,\n        //which will tell them to respawn/start\n        this.start();\n        return true;\n    }\n\n    start()\n    {\n        //right so a session has 2 avatars and wants to begin\n        //the host already knows they are hosting,\n        //tell the other client they are joining a session\n        //s=server message, j=you are joining, send them the host id\n        this.socket_client.send('s.j.' + this.socket_host.userid);\n        this.socket_client.session = this;\n\n        //now we tell both that the session is ready to start\n        //clients will reset their positions in this case.\n        this.socket_client.send('s.r.' + String(cm.get_owntime()).replace('.', '-'));\n        this.socket_host.send('s.r.' + String(cm.get_owntime()).replace('.', '-'));\n    }\n\n    //Updated at 15ms , simulates the world state\n    update_physics(pdt_)\n    {\n        //Handle avatars\n        for (let avatar of this.avatars)\n        {\n            avatar.old_state.pos = cm.new_pos(avatar.pos);\n            avatar.pos = cm.v_add(avatar.old_state.pos, cm.process_input(avatar));\n        }\n\n        //Keep the physics position in the world\n        for (let avatar of this.avatars)\n        {\n            cm.check_collision(avatar);\n            avatar.inputs = [];\n        }\n    }\n\n    handle_input(cl_, input_, input_time_, input_seq_)\n    {\n        //Fetch which client this refers to out of the two\n        let input_socket = cl_.userid == this.socket_host.userid ? this.avatars[0] : this.avatars[1];\n        //Store the input on the avatar instance for processing in the physics loop\n        input_socket.inputs.push({ inputs: input_, time: input_time_, seq: input_seq_ });\n    }\n}\n\r\nclass SvPresenter\n{\n    constructor()\n    {\n        //a local queue of packets we delay if faking latency\n        this.fake_latency = 0;\n        this.packets = [];\n        this.sessions = [];\n        this.session_count = 0;\n        this.verbose = false;\n        this.httpd = null;\n\n        // Model definition\n        this.model = new SvModel();\n    }\n\n    init_httpd()\n    {\n        let port = process.env.PORT || 4004,\n            express = require('express'),\n            http = require('http'),\n            app = express();\n        this.httpd = http.createServer(app);\n\n        /* Express server set up. */\n\n        //The express server handles passing our content to the browser,\n        //As well as routing users where they need to go. This example is bare bones\n        //and will serve any file the user requests from the root of your web server (where you launch the script from)\n        //so keep this in mind - this is not a production script but a development teaching tool.\n\n        //Tell the server to listen for incoming connections\n        this.httpd.listen(port);\n\n        //Log something so we know that it succeeded.\n        console.log('\\t :: Express :: Listening on port ' + port);\n\n        // By default, we forward the / path to index.html automatically.\n        app.get('/', (req_, res_) => {\n            console.log('trying to load %s', __dirname + '/index.html');\n            // let file = req_.path;\n            let options = { root: __dirname,\n                            dotfiles: 'deny',\n                            headers: { 'x-timestamp': Date.now(), 'x-sent': true } };\n            // console.log(\"file = \", file);\n            res_.sendFile('/index.html', options, (err_) => {\n                if (err_)\n                {\n                    console.log(err_);\n                    res_.status(err_.status).end();\n                }\n                else { /* console.log('Sent:', file); */ };\n            });\n        });\n\n        // Model\n        app.get('/model', (req_, res_, next_) => {\n            if (this.verbose) { console.log('\\t :: Express :: data requested as model'); }\n            res_.json(this.model.get_avatar_json());\n        });\n\n        // This handler will listen for requests on /*, any file from the root of our server.\n        // See expressjs documentation for more info on routing.\n\n        app.get('/*', (req_, res_, next_) => {\n            //This is the current file they have requested\n            // let file = req.params[0];\n\n            //Send the requesting client the file.\n            // res.sendfile(__dirname + '/' + file);\n            let file = req_.path;\n            //For debugging, we can track what files are requested.\n            if (this.verbose) { console.log('\\t :: Express :: file requested : ' + file); }\n            let options = { root: __dirname + '/',\n                            dotfiles: 'deny',\n                            headers: { 'x-timestamp': Date.now(), 'x-sent': true } };\n            // console.log(\"file = \", file);\n            res_.sendFile(file, options, (err_) => {\n                if (err_)\n                {\n                    console.log(err_);\n                    res_.status(err_.status).end();\n                }\n                else { /* console.log('Sent:', file); */ } });\n        });\n    }\n\n    init_socket()\n    {\n        /* Socket.IO server set up. */\n\n        //Express and socket.io can work together to serve the socket.io client files for you.\n        //This way, when the client requests '/socket.io/' files, socket.io determines what the client needs.\n\n        //Create a socket.io instance using our express server\n        let io = require('socket.io'),\n            UUID = require('node-uuid'),\n            sio = io.listen(this.httpd);\n\n        //Configure the socket.io connection settings.\n        //See http://socket.io/\n        sio.use((socket_, next_) => { let handshake = socket_.request; next_(); });\n\n        //Enter the session server code. The session server handles\n        //client connections looking for a session, creating sessions,\n        //leaving sessions, joining sessions and ending sessions when they leave.\n\n        //Socket.io will call this function when a client connects,\n        //So we can send that client looking for a session to play,\n        //as well as give that client a unique ID to use so we can\n        //maintain the list if avatars.\n        sio.sockets.on('connection', (socket_) => {\n            let cl_id = UUID();\n            //now we can find them a session to play with someone.\n            //if no session exists with someone waiting, they create one and wait.\n            let accepted_session = this.find_session_(socket_, cl_id);\n\n            //Useful to know when someone connects\n            console.log('\\t avatar: ' + accepted_session.id + ' connected');\n\n            //// register events\n            //Now we want to handle some of the messages that clients will send.\n            //They send messages here, and we send them to the sv to handle.\n            socket_.on('message', (msg_) => { this.on_recv_message_(socket_, cl_id, msg_); });\n\n            //When this client disconnects, we want to tell the session server\n            //about that as well, so it can remove them from the session they are\n            //in, and make sure the other avatar knows that they left and so on.\n            socket_.on('disconnect', () => {\n                //Useful to know when soomeone disconnects\n                console.log('\\t socket.io:: client disconnected ' + cl_id + ' ' + accepted_session.id);\n                //If the client was in a session, set by sv.find_session_,\n                //we can tell the session server to update that session state.\n                if (socket_ && accepted_session.id)\n                {\n                    //avatar leaving a session should destroy that session\n                    this.destroy_session_(accepted_session.id, cl_id);\n                }\n            });\n        });\n    }\n\n    log_() { if (this.verbose) { console.log.apply(this, arguments); } }\n\n    on_recv_message_(socket_, cl_id_, packet_)\n    {\n        if (this.fake_latency && packet_.split('.')[0].substr(0, 1) == 'i')\n        {\n            //store all input packet\n            this.packets.push({ client: socket_, packet: packet_ });\n            setTimeout(() => {\n                if (this.packets.length)\n                {\n                    this.proc_packet_(this.packets[0].client, this.packets[0].packet);\n                    this.packets.splice(0, 1);\n                }\n            },\n                       this.fake_latency);\n            return;\n        }\n        this.proc_packet_(socket_, packet_);\n    }\n\n    proc_packet_(socket_, packet_)\n    {\n        //Cut the packet up into sub components\n        let packet_parts = packet_.split('.'),\n        //The first is always the type of packet\n            packet_type = packet_parts[0];\n\n        let other_client = null;\n        if (socket_.session.socket_host.userid == socket_.userid)\n        { other_client = socket_.session.socket_client; }\n        else { other_client = socket_.session.socket_host; }\n\n        switch (packet_type)\n        {\n        case 'i': this.on_input_(socket_, packet_parts); break;// Input handler will forward this\n        case 'p': socket_.send('s.p.' + packet_parts[1]); break;\n        case 'c': if (other_client) { other_client.send('s.c.' + packet_parts[1]); } break; // Client changed their color!\n        case 'l': this.fake_latency = parseFloat(packet_parts[1]); break; // A client is asking for lag simulation\n        }\n    }\n\n    on_input_(socket_, parts_)\n    {\n        //The input commands come in like u-l,\n        //so we split them up into separate commands,\n        //and then update the avatars\n        let input_commands = parts_[1].split('-'),\n            input_time = parts_[2].replace('-', '.'),\n            input_seq = parts_[3];\n\n        //the client should be in a session, so\n        //we can tell that session to handle the input\n        if (socket_ && socket_.session)\n        { socket_.session.handle_input(socket_, input_commands, input_time, input_seq); }\n    }\n\n    find_session_(cl_socket_, cl_id_)\n    {\n        //Generate a new UUID, looks something like\n        //5b2ca132-64bd-4513-99da-90e838ca47d1\n        //and store this on their socket/connection\n        cl_socket_.userid = cl_id_;\n\n        //tell the avatar they connected, giving them their id\n        cl_socket_.emit('onconnected', { id: cl_id_ });\n\n        this.log_('looking for a session. We have : ' + this.session_count);\n        //if there are any sessions at all, no sessions? create one!\n        if (!this.session_count) { return this.create_session_(cl_socket_, cl_id_); }\n\n        //so there are sessions active,\n        //lets see if one needs another avatar\n        let joined_a_session = false, found_session = null;\n        //Check the list of sessions for an open session\n        for (let session_id in this.sessions) // for all sessions\n        {\n            //only care about our own properties.\n            if (!this.sessions.hasOwnProperty(session_id)) { continue; }\n            //get the session we are checking against\n            found_session = this.sessions[session_id];\n            //someone wants us to join!\n            joined_a_session = found_session.try_to_start(cl_socket_, cl_id_) || joined_a_session;\n        }\n\n        //now if we didn't join a session,\n        //we must create one\n        if (!joined_a_session) { return this.create_session_(cl_socket_, cl_id_); }\n        return found_session;\n    }\n\n    create_session_(host_socket_, cl_id_)\n    {\n        //Create a new session instance, this actually runs the\n        //session code like collisions and such.\n        let session = new SvSession(host_socket_, cl_id_);\n\n        //Store it in the list of session\n        this.sessions[session.id] = session;\n        //Keep track\n        this.session_count++;\n        //Start updating the session loop on the server\n        session.update(new Date().getTime());\n\n        host_socket_.session = session;\n\n        console.log('server host at  ' + cm.get_owntime());\n        this.log_('host ' + cl_id_ + ' created a session with id ' + host_socket_.session.id);\n        //return it\n        return session;\n    }\n\n    destroy_session_(session_id_, userid_)\n    {\n        let session = this.sessions[session_id_];\n        if (!session) { this.log_('that session was not found!'); return; }\n\n        //stop the session updates immediate\n        let left_socket = session.stop(userid_);\n        if (left_socket) { this.find_session_(left_socket); }\n\n        delete this.sessions[session_id_];\n        this.session_count--;\n        this.log_('session removed. there are now ' + this.session_count + ' sessions');\n    }\n};\n\n// on node.js\nlet server = new SvPresenter();\nserver.init_httpd();\nserver.init_socket();\n"]}